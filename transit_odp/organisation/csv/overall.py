from collections import OrderedDict

from pandas import DataFrame, merge

from transit_odp.common.collections import Column
from transit_odp.fares.models import DataCatalogueMetaData, FaresMetadata
from transit_odp.organisation.csv import EmptyDataFrame
from transit_odp.organisation.models import (
    Dataset,
    DatasetMetadata,
    DatasetRevision,
    TXCFileAttributes,
)

OVERALL_COLUMN_MAP = OrderedDict(
    {
        "organisation_name": Column(
            "Operator", "The name of the operator/publisher providing data on BODS."
        ),
        "organisation_id": Column(
            "Operator ID",
            "The internal BODS generated ID of the operator/publisher providing"
            " data on BODS.",
        ),
        "profile_nocs": Column(
            "Profile NOCs",
            (
                "The National Operator Codes for the particular publisher as extracted "
                "from their BODS profile."
            ),
        ),
        "dataset_type_pretty": Column("Data Type", "The type of data being published."),
        "status": Column("Status", "The publication status of the data set/feed."),
        "last_updated": Column(
            "Last Updated", "The date that the data set/feed was last updated on BODS."
        ),
        "upload_filename": Column(
            "File Name",
            "The exact name of the file provided to BODS. This is usually generated by "
            "the publisher or their supplier",
        ),
        "filename": Column(
            "XML File Name",
            "The value of the FileName attribute in the TransXChange file.",
        ),
        "name": Column(
            "Data Set/Feed Name",
            "The internal BODS generated data set name given for a particular"
            " data set.",
        ),
        "id": Column(
            "Data ID",
            "The internal BODS generated ID of the data set / feed provided to BODS.",
        ),
        "mode": Column(
            "Mode",
            "The mode of transport as extracted from the TransXChange "
            "file they provided.",
        ),
        "national_operator_code": Column(
            "National Operator Code",
            "The National Operator Codes for the particular publisher as extracted"
            " from the TransXChange file they provided.",
        ),
        "service_code": Column(
            "Service Code",
            "The ServiceCode for the particular publisher as extracted from "
            "the TransXChange file they provided.",
        ),
        "string_lines": Column(
            "Line Name",
            "The linename for the particular publisher as extracted from "
            "the TransXChange file they provided.",
        ),
    }
)

DATASET_FIELDS = (
    "organisation_name",
    "organisation_id",
    "profile_nocs",
    "dataset_type_pretty",
    "status",
    "last_updated",
    "upload_filename",
    "id",
    "name",
)

TXC_FILE_ATTRIBUTE_FIELDS = (
    "dataset_id",
    "filename",
    "national_operator_code",
    "service_code",
    "string_lines",
)

DATACATALOGUE_ATTRIBUTE_FIELDS = (
    "fares_metadata_id",
    "xml_file_name",
    "national_operator_code",
    "line_name",
)


def get_fares_data():
    """
    Returns list of fares information (xml file name, NOCs and line name)
    when dataset_id in DatasetRevision table match
    fares_metadata_id in DataCatalogueMetaData table.
    """
    dataset_ids_dict = (
        DataCatalogueMetaData.objects.filter(
            fares_metadata_id__in=FaresMetadata.objects.all().values_list(
                "datasetmetadata_ptr"
            )
        )
        .order_by("fares_metadata_id")
        .values(*DATACATALOGUE_ATTRIBUTE_FIELDS)
    )

    for dataset_id in dataset_ids_dict:
        revision_ids = DatasetMetadata.objects.filter(
            id=dataset_id.get("fares_metadata_id")
        ).values("revision_id")
        for revision_id in revision_ids:
            dataset_id["revision_id"] = revision_id["revision_id"]

        dataset_ids = DatasetRevision.objects.filter(
            id=dataset_id.get("revision_id")
        ).values("dataset_id")
        for dataset_id in dataset_ids:
            dataset_id["dataset_id"] = dataset_id["dataset_id"]

    return list(dataset_ids_dict)


def transform_lists(data_list):
    """
    Transform lists to seperate multiple values in a list
    with a semi-colon
    """
    transformed_string = "".join([str(data) + ";" for data in data_list])
    return transformed_string[: len(transformed_string) - 1]


def _get_overall_catalogue_dataframe() -> DataFrame:
    dataset_df = DataFrame.from_records(
        Dataset.objects.get_overall_data_catalogue_annotations().values(*DATASET_FIELDS)
    )
    txc_file_attributes_df = DataFrame.from_records(
        TXCFileAttributes.objects.get_overall_data_catalogue().values(
            *TXC_FILE_ATTRIBUTE_FIELDS
        )
    )
    if dataset_df.empty or txc_file_attributes_df.empty:
        raise EmptyDataFrame()

    merged = merge(
        dataset_df,
        txc_file_attributes_df,
        left_on="id",
        right_on="dataset_id",
        how="outer",
    )
    merged["mode"] = "Bus"
    merged = merged.sort_values("id")
    rename_map = {
        old_name: column_tuple.field_name
        for old_name, column_tuple in OVERALL_COLUMN_MAP.items()
    }
    merged = merged[OVERALL_COLUMN_MAP.keys()].rename(columns=rename_map)

    df_data_id_list = merged["Data ID"].tolist()
    all_data_dict = get_fares_data()

    for data_id in df_data_id_list:
        for data in all_data_dict:
            if data_id == data.get("dataset_id"):
                index = merged.index[merged["Data ID"] == data_id].values.astype(int)
                xml_file_name = data.get("xml_file_name")
                national_operator_code = transform_lists(
                    data.get("national_operator_code")
                )
                line_name = transform_lists(data.get("line_name"))

                merged.loc[index, ["XML File Name"]] = xml_file_name
                merged.loc[index, ["National Operator Code"]] = national_operator_code
                merged.loc[index, ["Line Name"]] = line_name

    return merged


def get_overall_data_catalogue_csv() -> str:
    return _get_overall_catalogue_dataframe().to_csv(index=False)
